<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diesel Ultra - Bot Engine Edition</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --sidebar: #151921; --accent: #00d2ff; --me: #005c4b; --text: #fff; --system: #2a2f3b; --danger: #ff4b4b; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        body.aero-mode { background: url('fon.png') no-repeat center center fixed; background-size: cover; }
        body.aero-mode .sidebar, body.aero-mode .main, body.aero-mode #auth-screen { background: rgba(0, 0, 0, 0.3) !important; backdrop-filter: blur(10px); }
        body.aero-mode input { background: url('Button3.png') no-repeat; background-size: 100% 100%; border: none; color: white; }
        body.aero-mode button { background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%), url('Button3.png') no-repeat; background-size: 100% 100%; color: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        body.aero-mode #send-btn { background: url('Button1.png') no-repeat; background-size: contain; background-position: center; color: transparent; width: 70px; height: 50px; }
        body.aero-mode #logo-img { content: url('ico.png'); width: 80px; height: auto; }

        .sidebar { width: 320px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #222; transition: transform 0.3s ease; z-index: 1000; }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; background: #080a0f; width: 100%; }
        
        @media (max-width: 768px) {
            .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            #back-btn { display: block !important; }
        }

        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); padding: 20px; }
        .card { background: var(--sidebar); padding: 20px; border-radius: 20px; width: 100%; max-width: 400px; border: 1px solid var(--accent); box-shadow: 0 0 20px rgba(0, 210, 255, 0.2); }
        
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 85%; padding: 10px; border-radius: 15px; font-size: 14px; position: relative; word-wrap: break-word; cursor: pointer; transition: transform 0.1s; }
        .bubble:active { transform: scale(0.98); }
        .bubble.me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 2px; }
        .bubble.other { align-self: flex-start; background: #262d31; border-bottom-left-radius: 2px; }
        
        .chat-item { padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #222; position: relative; }
        .chat-item.active { background: #2a2f3b; border-left: 4px solid var(--accent); }
        .chat-item .del-btn { position: absolute; right: 10px; color: var(--danger); font-size: 22px; padding: 5px; }

        input { background: var(--system); color: white; border: 1px solid #444; padding: 12px; border-radius: 8px; outline: none; margin: 5px 0; width: 100%; font-size: 16px; }
        button { background: var(--accent); border: none; padding: 12px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #000; transition: 0.2s; font-size: 14px; }
        button:active { opacity: 0.7; }

        .action-menu { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .action-btn { padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; cursor: pointer; border: 1px solid #444; }
        .btn-edit { background: var(--accent); color: #000; }
        .btn-del { background: var(--danger); color: #fff; }

        .ide-container { width: 100%; height: 100%; background: #1e1e1e; display: flex; flex-direction: column; overflow: hidden; }
        .ide-header { padding: 10px; background: #252526; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-wrap: wrap; gap: 5px; }
        #bot-code-editor { flex: 1; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace; padding: 15px; border: none; resize: none; outline: none; font-size: 14px; }
        
        #call-screen { display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; position: fixed; inset: 0; z-index: 10000; }
        .video-box { width: 90%; max-width: 400px; height: 45vh; background: #222; border-radius: 15px; margin-bottom: 10px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }

        .comment-trigger { font-size: 10px; color: var(--accent); margin-top: 5px; display: block; text-decoration: underline; }
        .comments-overlay { position: absolute; right: 0; top: 0; width: 100%; height: 100%; background: var(--bg); z-index: 100; display: none; flex-direction: column; }
    </style>
</head>
<body>

<div id="ui-modal" class="overlay">
    <div class="card" id="ui-card">
        <h3 id="ui-title" style="margin-top:0">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h3>
        <p id="ui-desc" style="font-size:14px; color:#ccc"></p>
        <div id="ui-content"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button id="ui-cancel" style="flex:1; background:#444; color:white">–û–¢–ú–ï–ù–ê</button>
            <button id="ui-confirm" style="flex:1; display: block;">–û–ö</button>
        </div>
    </div>
</div>

<div id="call-screen">
    <div class="video-box"><video id="remote-video" autoplay playsinline></video></div>
    <div class="video-box" style="height: 120px; width: 120px; position:absolute; bottom:100px; right:20px; border:2px solid var(--accent);"><video id="local-video" autoplay muted playsinline></video></div>
    <h2 id="call-status">–í—ã–∑–æ–≤...</h2>
    <button onclick="endCall()" style="background: #ff4b4b; color: white; padding: 15px 30px; border-radius: 50px;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
</div>

<div id="ide-modal" class="overlay" style="padding:0">
    <div class="ide-container">
        <div class="ide-header">
            <b style="font-size:12px">Diesel Bot IDE</b>
            <div style="display:flex; gap:5px">
                <button onclick="saveAndRunBot()" style="background: #4caf50; color: white; padding: 5px 10px;">SAVE</button>
                <button onclick="closeModals()" style="background: #444; color: white; padding: 5px 10px;">EXIT</button>
            </div>
        </div>
        <textarea id="bot-code-editor" spellcheck="false"></textarea>
    </div>
</div>

<div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div class="card" style="text-align: center;">
        <h1 id="logo-img" style="color: var(--accent); letter-spacing: 5px; margin-bottom:20px;">DIESEL</h1>
        <div id="step-email">
            <input type="email" id="email" placeholder="Email">
            <button onclick="sendEmailCode()" style="width: 100%; margin-top:10px;">–í–û–ô–¢–ò</button>
        </div>
        <div id="step-code" style="display:none">
            <input type="text" id="auth-code" placeholder="–ö–æ–¥ 0000" style="text-align:center;">
            <button onclick="verifyCode()" style="width: 100%; margin-top:10px;">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="overlay">
    <div class="card">
        <h3>–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <p style="font-size: 11px; color: var(--accent)">ID: <span id="display-id"></span></p>
        <input type="text" id="edit-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <input type="text" id="edit-ava" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏">
        <button onclick="saveProfile()" style="width:100%; margin-top:10px;">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button onclick="toggleAero()" style="width:100%; margin-top:10px; background: linear-gradient(45deg, #00d2ff, #3a7bd5); color:white">Aero Style</button>
        <button onclick="closeModals()" style="width:100%; margin-top:10px; background:#444; color:white">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div style="padding: 15px; background: #1c212c; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="openProfile()">
        <img id="my-ava-img" src="" class="avatar" style="width: 35px; height: 35px;">
        <b id="my-nick-display">...</b>
    </div>
    <div id="chat-list" style="flex: 1; overflow-y: auto;"></div>
    <div style="padding: 10px; border-top: 1px solid #222; background: var(--sidebar);">
        <button onclick="createChannelPrompt()" style="width: 100%; margin-bottom: 8px; background:#222; color:var(--accent)">+ –ö–ê–ù–ê–õ</button>
        <button onclick="openIDE()" style="width: 100%; margin-bottom: 8px; background: var(--accent); color:#000">IDE (–ë–û–¢)</button>
        <div style="display:flex; gap:5px;">
            <input type="text" id="add-id" placeholder="ID..." style="margin:0">
            <button onclick="addFriend()">+</button>
        </div>
    </div>
</div>

<div class="main">
    <div id="comments-view" class="comments-overlay">
        <div style="padding: 15px; background: var(--sidebar); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333;">
            <button onclick="closeComments()" style="background:none; color:var(--accent); font-size:20px;">‚Üê</button>
            <b id="comment-parent-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</b>
        </div>
        <div id="comment-messages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
        <div style="padding:15px; background:var(--sidebar); display:flex; gap:10px; align-items:center;">
            <input type="text" id="comment-input" placeholder="–¢–µ–∫—Å—Ç..." style="margin:0">
            <button onclick="sendComment()">‚û§</button>
        </div>
    </div>

    <div id="chat-header" style="padding: 10px 15px; background: var(--sidebar); border-bottom: 1px solid #222; display:flex; justify-content:space-between; align-items:center; min-height:60px;">
        <div style="display:flex; align-items:center; gap:10px; cursor:pointer; overflow:hidden;" onclick="editCurrentChannel()">
            <button onclick="toggleSidebar(event)" id="back-btn" style="display:none; padding:5px 12px; margin-right:5px; background:#333; color:white;">‚â°</button>
            <div style="display:flex; flex-direction:column; overflow:hidden;">
                <b id="active-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Diesel Chat</b>
                <small id="active-info" style="font-size:10px; color:var(--accent)"></small>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="call-btn" style="display:none; background:none; color:var(--accent); font-size:18px;" onclick="startCall()">üìû</button>
        </div>
    </div>

    <div id="messages"></div>

    <div id="input-area" style="padding: 10px; background: var(--sidebar); display: flex; gap: 8px; align-items: center;">
        <button class="attach-btn" style="background:none; color:var(--accent); font-size:22px; padding:0 5px;" onclick="document.getElementById('file-input').click()">üìé</button>
        <input type="file" id="file-input" style="display:none" onchange="uploadFile(this)">
        <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
        <button id="send-btn" onclick="sendMsg()" style="padding:10px 18px;">‚û§</button>
    </div>
</div>

<iframe id="bot-sandbox" style="display:none" sandbox="allow-scripts"></iframe>

<script>
    const BASE = "https://diesel-c8b6a-default-rtdb.firebaseio.com";
    const DEF_AVA = "https://basket-25.wbbasket.ru/vol4382/part438234/438234188/images/big/1.webp";
    const EJS_SERVICE = "service_tdsibs5", EJS_TEMPLATE = "template_c2m28lg", EJS_PUBLIC = "L0fjG_jIAPW3x015-";
    
    let MY_ID = "", MY_NICK = "", MY_AVA = "", ACTIVE_CHAT = "", MY_TYPE = "", CURRENT_BOT_ID = "";
    let lastChatHash = "", lastMsgHash = "", lastCommentHash = "";
    let peer, localStream, currentCall, ACTIVE_COMMENT_ID = "";

    function toggleSidebar(e) {
        if(e) e.stopPropagation();
        document.getElementById('sidebar').classList.toggle('active');
    }

    function customUI({ title, desc, type, value, onConfirm }) {
        const modal = document.getElementById('ui-modal');
        const content = document.getElementById('ui-content');
        const confirmBtn = document.getElementById('ui-confirm');
        const cancelBtn = document.getElementById('ui-cancel');
        
        document.getElementById('ui-title').innerText = title || "Diesel Ultra";
        document.getElementById('ui-desc').innerText = desc || "";
        content.innerHTML = "";
        modal.style.display = 'flex';
        confirmBtn.style.display = 'block';

        if (type === 'input') {
            const input = document.createElement('input');
            input.value = value || "";
            input.id = "ui-input-field";
            content.appendChild(input);
        } else if (type === 'actions') {
            confirmBtn.style.display = 'none';
            const wrap = document.createElement('div');
            wrap.className = 'action-menu';
            
            const acts = [
                {t: '–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨', c: 'btn-edit', a: 'edit'},
                {t: '–£–î–ê–õ–ò–¢–¨ –°–û–û–ë–©–ï–ù–ò–ï', c: 'btn-del', a: 'del'},
                {t: '–£–î–ê–õ–ò–¢–¨ –í–ï–°–¨ –ß–ê–¢', c: 'btn-del', a: 'del_chat'}
            ];

            acts.forEach(act => {
                const b = document.createElement('div');
                b.className = 'action-btn ' + act.c;
                b.innerText = act.t;
                b.onclick = () => { closeModals(); onConfirm(act.a); };
                wrap.appendChild(b);
            });
            content.appendChild(wrap);
        }

        confirmBtn.onclick = () => {
            const val = document.getElementById('ui-input-field')?.value;
            closeModals();
            if (onConfirm) onConfirm(val || true);
        };
        cancelBtn.onclick = () => { closeModals(); };
    }

    async function editCurrentChannel() {
        if (MY_TYPE !== 'channel') return;
        let info = await (await fetch(`${BASE}/entities/${ACTIVE_CHAT}.json`)).json();
        if (info.owner !== MY_ID) return;

        customUI({
            title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞",
            desc: "–ù–∞–∑–≤–∞–Ω–∏–µ:",
            type: 'input',
            value: info.name,
            onConfirm: async (newName) => {
                if(!newName) return;
                customUI({
                    title: "–ê–≤–∞—Ç–∞—Ä–∫–∞",
                    desc: "URL:",
                    type: 'input',
                    value: info.ava,
                    onConfirm: async (newAva) => {
                        await fetch(`${BASE}/entities/${ACTIVE_CHAT}.json`, { 
                            method:'PATCH', 
                            body: JSON.stringify({ name: newName, ava: newAva || DEF_AVA }) 
                        });
                        sync();
                    }
                });
            }
        });
    }

    function openComments(mid, text) {
        ACTIVE_COMMENT_ID = mid;
        document.getElementById('comment-parent-title').innerText = text.substring(0, 15) + "...";
        document.getElementById('comments-view').style.display = 'flex';
        lastCommentHash = "";
        syncComments();
    }

    function closeComments() {
        document.getElementById('comments-view').style.display = 'none';
        ACTIVE_COMMENT_ID = "";
    }

    async function sendComment() {
        const txt = document.getElementById('comment-input').value;
        if(!txt || !ACTIVE_COMMENT_ID) return;
        const msg = { sid: MY_ID, sender: MY_NICK, ava: MY_AVA, text: txt, ts: Date.now() };
        await fetch(`${BASE}/comments/${ACTIVE_COMMENT_ID}.json`, { method:'POST', body: JSON.stringify(msg) });
        document.getElementById('comment-input').value = "";
    }

    async function syncComments() {
        if(!ACTIVE_COMMENT_ID) return;
        let cData = await (await fetch(`${BASE}/comments/${ACTIVE_COMMENT_ID}.json`)).json();
        if(JSON.stringify(cData) !== lastCommentHash) {
            lastCommentHash = JSON.stringify(cData);
            const box = document.getElementById('comment-messages'); box.innerHTML = "";
            if(cData) {
                Object.keys(cData).forEach(cid => {
                    let m = cData[cid], b = document.createElement('div');
                    b.className = `bubble ${m.sid === MY_ID ? 'me' : 'other'}`;
                    b.innerHTML = `<small style="color:var(--accent)">${m.sender}</small><div>${m.text}</div>`;
                    box.appendChild(b);
                });
                box.scrollTop = box.scrollHeight;
            }
        }
    }

    window.addEventListener('message', async (e) => {
        if(e.data.type === 'bot_send_msg') {
            const bot = e.data.bot;
            const room = [bot.id, e.data.target].sort().join("_");
            const msg = { sid: bot.id, sender: bot.nick, ava: bot.ava, text: e.data.text, ts: Date.now() };
            await fetch(`${BASE}/chats/${room}.json`, { method:'POST', body: JSON.stringify(msg) });
        }
        if(e.data.type === 'bot_reply') {
            const bot = e.data.bot;
            const msg = { sid: bot.id, sender: bot.nick, ava: bot.ava, text: e.data.text, ts: Date.now() };
            await fetch(`${BASE}/comments/${e.data.targetId}.json`, { method:'POST', body: JSON.stringify(msg) });
        }
    });

    function openIDE(botId = null) {
        if(botId) {
            CURRENT_BOT_ID = botId;
            fetch(`${BASE}/users/${botId}.json`).then(r => r.json()).then(data => {
                document.getElementById('bot-code-editor').value = data.code;
                document.getElementById('ide-modal').style.display = 'flex';
            });
        } else {
            CURRENT_BOT_ID = "";
            document.getElementById('bot-code-editor').value = "BotAPI.onMessage((msg) => {\n    if(msg.text === '–ü—Ä–∏–≤–µ—Ç') {\n        BotAPI.sendMessage('–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç.');\n    }\n});";
            document.getElementById('ide-modal').style.display = 'flex';
        }
    }

    async function saveAndRunBot() {
        const code = document.getElementById('bot-code-editor').value;
        const botId = CURRENT_BOT_ID || "bot_" + Math.random().toString(36).substr(2, 6);
        const botData = { id: botId, nick: CURRENT_BOT_ID ? undefined : "Bot_" + botId.slice(4), ava: CURRENT_BOT_ID ? undefined : "https://cdn-icons-png.flaticon.com/512/4712/4712035.png", owner: MY_ID, code: code, type: 'bot' };
        await fetch(`${BASE}/users/${botId}.json`, { method:'PATCH', body: JSON.stringify(botData) });
        if(!CURRENT_BOT_ID) await fetch(`${BASE}/contacts/${MY_ID}/${botId}.json`, { method:'PUT', body: JSON.stringify({ type: 'bot' }) });
        closeModals();
        sync();
    }

    function runBotEngine(botInfo, newMsg) {
        const sandbox = document.getElementById('bot-sandbox');
        const botScript = `const BotAPI = { onMessage: (callback) => { const msg = ${JSON.stringify(newMsg)}; if(msg.sid !== "${botInfo.id}") callback(msg); }, sendMessage: (txt) => { window.parent.postMessage({ type: 'bot_send_msg', bot: ${JSON.stringify(botInfo)}, target: "${newMsg.sid}", text: txt }, '*'); } }; try { ${botInfo.code} } catch(e) {}`;
        sandbox.srcdoc = `<script>${botScript}<\/script>`;
    }

    emailjs.init(EJS_PUBLIC);

    function initPeer() {
        peer = new Peer(MY_ID);
        peer.on('call', call => {
            customUI({
                title: "–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤",
                desc: "–ü—Ä–∏–Ω—è—Ç—å?",
                onConfirm: () => {
                    navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                        localStream = stream;
                        document.getElementById('local-video').srcObject = stream;
                        document.getElementById('call-screen').style.display = 'flex';
                        call.answer(stream);
                        call.on('stream', remoteStream => { document.getElementById('remote-video').srcObject = remoteStream; });
                        currentCall = call;
                    });
                }
            });
        });
    }

    async function startCall() {
        if(!ACTIVE_CHAT) return;
        document.getElementById('call-screen').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local-video').srcObject = localStream;
        const call = peer.call(ACTIVE_CHAT, localStream);
        call.on('stream', remoteStream => {
            document.getElementById('remote-video').srcObject = remoteStream;
            document.getElementById('call-status').innerText = "–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ";
        });
        currentCall = call;
    }

    function endCall() {
        if(currentCall) currentCall.close();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-screen').style.display = 'none';
    }

    async function checkAuth() {
        const savedId = localStorage.getItem('my_diesel_id');
        if (savedId) {
            let user = await (await fetch(`${BASE}/users/${savedId}.json`)).json();
            if (user) {
                MY_ID = savedId; MY_NICK = user.nick; MY_AVA = user.ava || DEF_AVA;
                document.getElementById('auth-screen').style.display = 'none';
                updateUI(); initPeer(); setInterval(sync, 2000);
            }
        }
    }
    checkAuth();

    async function uploadFile(input) {
        const file = input.files[0];
        if (!file || !ACTIVE_CHAT) return;
        sendMsg(`[file] ${file.name}`);
    }

    function toggleAero() {
        document.body.classList.toggle('aero-mode');
        localStorage.setItem('aero', document.body.classList.contains('aero-mode'));
    }
    if(localStorage.getItem('aero') === 'true') document.body.classList.add('aero-mode');

    function openProfile() {
        document.getElementById('display-id').innerText = MY_ID;
        document.getElementById('edit-nick').value = MY_NICK;
        document.getElementById('edit-ava').value = MY_AVA;
        document.getElementById('profile-modal').style.display = 'flex';
    }

    async function saveProfile() {
        MY_NICK = document.getElementById('edit-nick').value;
        MY_AVA = document.getElementById('edit-ava').value || DEF_AVA;
        await fetch(`${BASE}/users/${MY_ID}.json`, { method:'PATCH', body: JSON.stringify({ nick: MY_NICK, ava: MY_AVA }) });
        updateUI(); closeModals();
    }

    async function addFriend() {
        const id = document.getElementById('add-id').value.trim();
        if(!id) return;
        let type = id.startsWith('chan_') ? 'channel' : (id.startsWith('bot_') ? 'bot' : 'user');
        await fetch(`${BASE}/contacts/${MY_ID}/${id}.json`, { method:'PUT', body: JSON.stringify({ type }) });
        document.getElementById('add-id').value = "";
        sync();
    }

    async function sendMsg(customTxt = null) {
        const txt = customTxt || document.getElementById('msg-input').value;
        if(!txt || !ACTIVE_CHAT) return;
        const msg = { sid: MY_ID, sender: MY_NICK, ava: MY_AVA, text: txt, ts: Date.now() };
        let room = (MY_TYPE !== 'channel') ? [MY_ID, ACTIVE_CHAT].sort().join("_") : ACTIVE_CHAT;
        await fetch(`${BASE}/chats/${room}.json`, { method:'POST', body: JSON.stringify(msg) });
        document.getElementById('msg-input').value = "";
    }

    async function handleMsgAction(mid, text, sid) {
        customUI({
            title: "–î–µ–π—Å—Ç–≤–∏–µ",
            type: 'actions',
            onConfirm: async (action) => {
                let room = (MY_TYPE !== 'channel') ? [MY_ID, ACTIVE_CHAT].sort().join("_") : ACTIVE_CHAT;
                if(action === 'del' && sid === MY_ID) {
                    await fetch(`${BASE}/chats/${room}/${mid}.json`, { method:'DELETE' });
                } else if(action === 'edit' && sid === MY_ID) {
                    customUI({
                        title: "–ü—Ä–∞–≤–∫–∞",
                        type: 'input',
                        value: text,
                        onConfirm: async (newText) => {
                            if(newText) await fetch(`${BASE}/chats/${room}/${mid}.json`, { method:'PATCH', body: JSON.stringify({ text: newText }) });
                        }
                    });
                } else if(action === 'del_chat') {
                    await fetch(`${BASE}/contacts/${MY_ID}/${ACTIVE_CHAT}.json`, { method:'DELETE' });
                    ACTIVE_CHAT = "";
                    sync();
                }
            }
        });
    }

    async function createChannelPrompt() {
        customUI({
            title: "–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª",
            desc: "–ù–∞–∑–≤–∞–Ω–∏–µ:",
            type: 'input',
            onConfirm: async (name) => {
                if(!name) return;
                const cid = "chan_" + Math.random().toString(36).substr(2, 6);
                await fetch(`${BASE}/entities/${cid}.json`, { method:'PUT', body: JSON.stringify({ name, ava: DEF_AVA, owner: MY_ID, type: 'channel', subs: 1 }) });
                await fetch(`${BASE}/contacts/${MY_ID}/${cid}.json`, { method:'PUT', body: JSON.stringify({ type: 'channel' }) });
                sync();
            }
        });
    }

    async function deleteEntity(id, type) {
        customUI({
            title: "–£–¥–∞–ª–µ–Ω–∏–µ",
            desc: "–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?",
            onConfirm: async () => {
                const path = (type === 'channel') ? `entities/${id}` : `users/${id}`;
                await fetch(`${BASE}/${path}.json`, { method:'DELETE' });
                await fetch(`${BASE}/contacts/${MY_ID}/${id}.json`, { method:'DELETE' });
                if(ACTIVE_CHAT === id) ACTIVE_CHAT = "";
                sync();
            }
        });
    }

    async function sendEmailCode() {
        const mail = document.getElementById('email').value;
        if(!mail.includes('@')) return;
        MY_ID = btoa(mail).substring(0, 8);
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        await fetch(`${BASE}/auth_temp/${MY_ID}.json`, { method:'PUT', body: JSON.stringify({ code, email: mail }) });
        emailjs.send(EJS_SERVICE, EJS_TEMPLATE, { name: "DIESEL", message: `–ö–æ–¥: ${code}`, to_email: mail }).then(() => {
            document.getElementById('step-email').style.display = 'none';
            document.getElementById('step-code').style.display = 'block';
        });
    }

    async function verifyCode() {
        const code = document.getElementById('auth-code').value;
        let data = await (await fetch(`${BASE}/auth_temp/${MY_ID}.json`)).json();
        if(data && data.code === code) {
            let user = await (await fetch(`${BASE}/users/${MY_ID}.json`)).json();
            if(!user) {
                user = { nick: "User_"+MY_ID, id: MY_ID, ava: DEF_AVA, email: data.email };
                await fetch(`${BASE}/users/${MY_ID}.json`, { method:'PUT', body: JSON.stringify(user) });
            }
            MY_NICK = user.nick; MY_AVA = user.ava || DEF_AVA;
            localStorage.setItem('my_diesel_id', MY_ID); 
            document.getElementById('auth-screen').style.display = 'none';
            updateUI(); initPeer(); setInterval(sync, 2000);
        }
    }

    function updateUI() {
        document.getElementById('my-nick-display').innerText = MY_NICK;
        document.getElementById('my-ava-img').src = MY_AVA;
    }

    async function sync() {
        if(!MY_ID) return;
        if(ACTIVE_COMMENT_ID) syncComments();

        let cData = await (await fetch(`${BASE}/contacts/${MY_ID}.json`)).json();
        if(JSON.stringify(cData) !== lastChatHash) {
            lastChatHash = JSON.stringify(cData);
            const list = document.getElementById('chat-list'); list.innerHTML = "";
            for(let id in cData) {
                let info = await (await fetch(`${BASE}/users/${id}.json`)).json();
                if(!info) info = await (await fetch(`${BASE}/entities/${id}.json`)).json();
                let div = document.createElement('div');
                div.className = `chat-item ${ACTIVE_CHAT === id ? 'active' : ''}`;
                div.innerHTML = `<img src="${info?.ava || DEF_AVA}" class="avatar"> <b>${info?.name || info?.nick || id}</b>`;
                if(info?.owner === MY_ID) {
                    let del = document.createElement('span'); del.className = 'del-btn'; del.innerHTML = '&times;';
                    del.onclick = (e) => { e.stopPropagation(); deleteEntity(id, cData[id].type); };
                    div.appendChild(del);
                    if(cData[id].type === 'bot') div.ondblclick = () => openIDE(id);
                }
                div.onclick = () => { 
                    ACTIVE_CHAT = id; MY_TYPE = cData[id].type;
                    document.getElementById('active-title').innerText = info?.name || info?.nick;
                    document.getElementById('active-info').innerText = `ID: ${id}`;
                    document.getElementById('call-btn').style.display = (MY_TYPE === 'user') ? "block" : "none";
                    if(window.innerWidth <= 768) toggleSidebar();
                    lastMsgHash = ""; sync();
                };
                list.appendChild(div);
            }
        }
        if(ACTIVE_CHAT) {
            let room = (MY_TYPE !== 'channel') ? [MY_ID, ACTIVE_CHAT].sort().join("_") : ACTIVE_CHAT;
            let mData = await (await fetch(`${BASE}/chats/${room}.json`)).json();
            if(JSON.stringify(mData) !== lastMsgHash) {
                const isNew = lastMsgHash !== "" && mData;
                lastMsgHash = JSON.stringify(mData);
                const box = document.getElementById('messages'); box.innerHTML = "";
                if(mData) {
                    const keys = Object.keys(mData);
                    keys.forEach(mid => {
                        let m = mData[mid], b = document.createElement('div');
                        b.className = `bubble ${m.sid === MY_ID ? 'me' : 'other'}`;
                        let commentBtn = (MY_TYPE === 'channel') ? `<span class="comment-trigger" onclick="event.stopPropagation(); openComments('${mid}', '${m.text}')">–û—Ç–≤–µ—Ç—ã</span>` : "";
                        b.innerHTML = `<small style="color:var(--accent); font-size:10px;">${m.sender}</small><div>${m.text}</div>${commentBtn}`;
                        b.onclick = () => handleMsgAction(mid, m.text, m.sid);
                        box.appendChild(b);
                    });
                    box.scrollTop = box.scrollHeight;
                    if(MY_TYPE === 'bot' && isNew) {
                        const lastMsg = mData[keys[keys.length-1]];
                        if(lastMsg.sid !== ACTIVE_CHAT) {
                            let botInfo = await (await fetch(`${BASE}/users/${ACTIVE_CHAT}.json`)).json();
                            if(botInfo && botInfo.code) runBotEngine(botInfo, lastMsg);
                        }
                    }
                }
            }
        }
    }
    function closeModals() { document.querySelectorAll('.overlay').forEach(m => m.style.display = 'none'); }
</script>
</body>
</html>
