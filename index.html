<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diesel Ultra - Mobile Edition</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --sidebar: #151921; --accent: #00d2ff; --me: #005c4b; --text: #fff; --system: #2a2f3b; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        body.aero-mode { background: url('fon.png') no-repeat center center fixed; background-size: cover; }
        body.aero-mode .sidebar, body.aero-mode .main, body.aero-mode #auth-screen { background: rgba(0, 0, 0, 0.3) !important; backdrop-filter: blur(10px); }
        body.aero-mode input { background: url('Button3.png') no-repeat; background-size: 100% 100%; border: none; color: white; }
        body.aero-mode button { background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%), url('Button3.png') no-repeat; background-size: 100% 100%; color: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        body.aero-mode #send-btn { background: url('Button1.png') no-repeat; background-size: contain; background-position: center; color: transparent; width: 70px; height: 50px; }
        body.aero-mode #logo-img { content: url('ico.png'); width: 80px; height: auto; }

        .sidebar { width: 320px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #222; transition: 0.3s; z-index: 10; }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; background: #080a0f; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .card { background: var(--sidebar); padding: 20px; border-radius: 20px; width: 300px; border: 1px solid var(--accent); }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 85%; padding: 10px; border-radius: 15px; font-size: 14px; position: relative; word-wrap: break-word; }
        .bubble img, .bubble video { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        .bubble.me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 2px; }
        .bubble.other { align-self: flex-start; background: #262d31; border-bottom-left-radius: 2px; }
        .chat-item { padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #222; }
        .chat-item.active { background: #2a2f3b; border-left: 4px solid var(--accent); }
        .comm-btn { font-size: 11px; color: var(--accent); cursor: pointer; margin-top: 5px; display: inline-block; }
        .comment { font-size: 12px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; margin-top: 3px; border-left: 2px solid var(--accent); }
        input { background: var(--system); color: white; border: none; padding: 12px; border-radius: 8px; flex: 1; outline: none; margin: 5px 0; width: -webkit-fill-available; }
        button { background: var(--accent); border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #000; }
        .attach-btn { background: none; color: var(--accent); font-size: 20px; padding: 5px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–≤–æ–Ω–∫–∞ */
        #call-screen { display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; position: fixed; inset: 0; z-index: 10000; }
        .video-box { width: 90%; max-width: 400px; height: 300px; background: #222; border-radius: 15px; margin-bottom: 10px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="call-screen">
    <div class="video-box"><video id="remote-video" autoplay></video></div>
    <div class="video-box" style="height: 150px; width: 150px;"><video id="local-video" autoplay muted></video></div>
    <h2 id="call-status">–í—ã–∑–æ–≤...</h2>
    <button onclick="endCall()" style="background: #ff4b4b; color: white; padding: 20px 40px; border-radius: 50px;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
</div>

<div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="card" style="text-align: center;">
        <h1 id="logo-img" style="color: var(--accent); letter-spacing: 5px;">DIESEL</h1>
        <div id="step-email">
            <input type="email" id="email" placeholder="Email"><br>
            <button onclick="sendEmailCode()" style="width: 100%">–í–û–ô–¢–ò</button>
        </div>
        <div id="step-code" style="display:none">
            <input type="text" id="auth-code" placeholder="–ö–æ–¥ 0000" style="text-align:center;"><br>
            <button onclick="verifyCode()" style="width: 100%">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="overlay">
    <div class="card">
        <h3>–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <p style="font-size: 11px; color: var(--accent)">ID: <span id="display-id"></span></p>
        <input type="text" id="edit-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <input type="text" id="edit-ava" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏">
        <button onclick="saveProfile()" style="width:100%">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button onclick="toggleAero()" style="width:100%; margin-top:10px; background: linear-gradient(45deg, #00d2ff, #3a7bd5); color:white">Aero Style</button>
        <button onclick="closeModals()" style="width:100%; margin-top:10px; background:#444; color:white">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div style="padding: 15px; background: #1c212c; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="openProfile()">
        <img id="my-ava-img" src="" class="avatar" style="width: 35px; height: 35px;">
        <b id="my-nick-display">...</b>
    </div>
    <div id="chat-list" style="flex: 1; overflow-y: auto;"></div>
    <div style="padding: 10px; border-top: 1px solid #222;">
        <button onclick="createChannelPrompt()" style="width: 100%; margin-bottom: 8px; background:#222; color:var(--accent)">+ –ö–ê–ù–ê–õ</button>
        <input type="text" id="add-id" placeholder="ID –¥—Ä—É–≥–∞/–∫–∞–Ω–∞–ª–∞...">
        <button onclick="addFriend()" style="width: 100%">–î–û–ë–ê–í–ò–¢–¨</button>
    </div>
</div>

<div class="main">
    <div id="chat-header" style="padding: 15px; background: var(--sidebar); border-bottom: 1px solid #222; display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:10px">
            <button onclick="toggleSidebar()" id="back-btn" style="display:none; padding:5px 10px">‚Üê</button>
            <div style="display:flex; flex-direction:column">
                <b id="active-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
                <small id="active-info" style="font-size:10px; color:var(--accent)"></small>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="call-btn" style="display:none; background:none; color:var(--accent); font-size:18px;" onclick="startCall()">üìû</button>
            <button id="chan-settings-btn" style="display:none" onclick="editChannelPrompt()">‚öôÔ∏è</button>
        </div>
    </div>
    <div id="messages"></div>
    <div id="input-area" style="padding: 15px; background: var(--sidebar); display: flex; gap: 10px; align-items: center;">
        <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
        <input type="file" id="file-input" style="display:none" onchange="uploadFile(this)">
        <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-btn" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<script>
    const BASE = "https://diesel-c8b6a-default-rtdb.firebaseio.com";
    const DEF_AVA = "https://basket-25.wbbasket.ru/vol4382/part438234/438234188/images/big/1.webp";
    const EJS_SERVICE = "service_tdsibs5", EJS_TEMPLATE = "template_c2m28lg", EJS_PUBLIC = "L0fjG_jIAPW3x015-";
    
    let MY_ID = "", MY_NICK = "", MY_AVA = "", ACTIVE_CHAT = "", MY_TYPE = "", OWNER = "";
    let lastChatHash = "", lastMsgHash = "";
    let peer, localStream, currentCall;

    emailjs.init(EJS_PUBLIC);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤–æ–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ PeerJS
    function initPeer() {
        peer = new Peer(MY_ID);
        peer.on('call', call => {
            if(confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫! –ü—Ä–∏–Ω—è—Ç—å?")) {
                navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                    localStream = stream;
                    document.getElementById('local-video').srcObject = stream;
                    document.getElementById('call-screen').style.display = 'flex';
                    call.answer(stream);
                    call.on('stream', remoteStream => {
                        document.getElementById('remote-video').srcObject = remoteStream;
                    });
                    currentCall = call;
                });
            }
        });
    }

    async function startCall() {
        if(!ACTIVE_CHAT) return;
        document.getElementById('call-screen').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local-video').srcObject = localStream;
        
        const call = peer.call(ACTIVE_CHAT, localStream);
        call.on('stream', remoteStream => {
            document.getElementById('remote-video').srcObject = remoteStream;
            document.getElementById('call-status').innerText = "–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ";
        });
        currentCall = call;
    }

    function endCall() {
        if(currentCall) currentCall.close();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-screen').style.display = 'none';
    }

    async function checkAuth() {
        const savedId = localStorage.getItem('my_diesel_id');
        if (savedId) {
            let user = await (await fetch(`${BASE}/users/${savedId}.json`)).json();
            if (user) {
                MY_ID = savedId;
                MY_NICK = user.nick;
                MY_AVA = user.ava || DEF_AVA;
                document.getElementById('auth-screen').style.display = 'none';
                updateUI();
                initPeer();
                setInterval(sync, 2000);
            }
        }
    }
    checkAuth();

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (–ò–º–∏—Ç–∞—Ü–∏—è –∏–ª–∏ —á–µ—Ä–µ–∑ —Ç–≤–æ–π Firebase Storage / —Å—Ç–æ—Ä–æ–Ω–Ω–∏–π API)
    async function uploadFile(input) {
        const file = input.files[0];
        if (!file || !ACTIVE_CHAT) return;
        if (file.size > 500 * 1024 * 1024) return alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –õ–∏–º–∏—Ç 500–ú–ë.");

        const reader = new FileReader();
        reader.onload = async (e) => {
            const dataUrl = e.target.result;
            let type = 'file';
            if (file.type.startsWith('image/')) type = 'img';
            else if (file.type.startsWith('video/')) type = 'vid';
            
            // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –Ω—É–∂–Ω–æ –ª–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (Cloudinary/Firebase Storage)
            // –ó–¥–µ—Å—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ Base64 (–¥–ª—è —Ç–µ—Å—Ç–∞) –∏–ª–∏ —Å—Å—ã–ª–∫—É
            sendMsg(`[${type}]${file.name}|${dataUrl.substring(0, 100)}...`); 
            alert("–§–∞–π–ª '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' (–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ 500–ú–ë –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è)");
        };
        reader.readAsDataURL(file);
    }

    function toggleAero() {
        document.body.classList.toggle('aero-mode');
        localStorage.setItem('aero', document.body.classList.contains('aero-mode'));
    }
    if(localStorage.getItem('aero') === 'true') document.body.classList.add('aero-mode');

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }

    function openProfile() {
        document.getElementById('display-id').innerText = MY_ID;
        document.getElementById('edit-nick').value = MY_NICK;
        document.getElementById('edit-ava').value = MY_AVA;
        document.getElementById('profile-modal').style.display = 'flex';
    }

    async function saveProfile() {
        MY_NICK = document.getElementById('edit-nick').value;
        MY_AVA = document.getElementById('edit-ava').value || DEF_AVA;
        await fetch(`${BASE}/users/${MY_ID}.json`, { method:'PATCH', body: JSON.stringify({ nick: MY_NICK, ava: MY_AVA }) });
        updateUI(); closeModals();
    }

    async function createChannelPrompt() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:");
        if(!name) return;
        const cid = "chan_" + Math.random().toString(36).substr(2, 6);
        await fetch(`${BASE}/entities/${cid}.json`, { method:'PUT', body: JSON.stringify({ name, ava: DEF_AVA, owner: MY_ID, type: 'channel', subs: 1 }) });
        await fetch(`${BASE}/contacts/${MY_ID}/${cid}.json`, { method:'PUT', body: JSON.stringify({ type: 'channel' }) });
    }

    async function addFriend() {
        const id = document.getElementById('add-id').value.trim();
        if(!id) return;
        let type = id.startsWith('chan_') ? 'channel' : 'user';
        await fetch(`${BASE}/contacts/${MY_ID}/${id}.json`, { method:'PUT', body: JSON.stringify({ type }) });
        if(type === 'channel') fetch(`${BASE}/entities/${id}/subs.json`).then(r => r.json()).then(s => fetch(`${BASE}/entities/${id}.json`, {method:'PATCH', body: JSON.stringify({subs: (s||0)+1})}));
        document.getElementById('add-id').value = "";
    }

    async function sendMsg(customTxt = null) {
        const txt = customTxt || document.getElementById('msg-input').value;
        if(!txt || !ACTIVE_CHAT) return;
        const msg = { sid: MY_ID, sender: MY_NICK, ava: MY_AVA, text: txt, ts: Date.now() };
        let room = (MY_TYPE === 'user') ? [MY_ID, ACTIVE_CHAT].sort().join("_") : ACTIVE_CHAT;
        await fetch(`${BASE}/chats/${room}.json`, { method:'POST', body: JSON.stringify(msg) });
        document.getElementById('msg-input').value = "";
    }

    async function sendEmailCode() {
        const mail = document.getElementById('email').value;
        if(!mail.includes('@')) return alert("Email!");
        MY_ID = btoa(mail).substring(0, 8);
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        await fetch(`${BASE}/auth_temp/${MY_ID}.json`, { method:'PUT', body: JSON.stringify({ code, email: mail }) });
        emailjs.send(EJS_SERVICE, EJS_TEMPLATE, { name: "DIESEL", message: `–ö–æ–¥: ${code}`, to_email: mail }).then(() => {
            document.getElementById('step-email').style.display = 'none';
            document.getElementById('step-code').style.display = 'block';
        });
    }

    async function verifyCode() {
        const code = document.getElementById('auth-code').value;
        let data = await (await fetch(`${BASE}/auth_temp/${MY_ID}.json`)).json();
        if(data && data.code === code) {
            let user = await (await fetch(`${BASE}/users/${MY_ID}.json`)).json();
            if(!user) {
                user = { nick: "User_"+MY_ID, id: MY_ID, ava: DEF_AVA, email: data.email };
                await fetch(`${BASE}/users/${MY_ID}.json`, { method:'PUT', body: JSON.stringify(user) });
            }
            MY_NICK = user.nick; MY_AVA = user.ava || DEF_AVA;
            localStorage.setItem('my_diesel_id', MY_ID); 
            document.getElementById('auth-screen').style.display = 'none';
            updateUI(); initPeer(); setInterval(sync, 2000);
        }
    }

    function updateUI() {
        document.getElementById('my-nick-display').innerText = MY_NICK;
        document.getElementById('my-ava-img').src = MY_AVA;
    }

    async function sync() {
        if(!MY_ID) return;
        let cData = await (await fetch(`${BASE}/contacts/${MY_ID}.json`)).json();
        if(JSON.stringify(cData) !== lastChatHash) {
            lastChatHash = JSON.stringify(cData);
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            for(let id in cData) {
                let info = (id.startsWith('chan_')) ? await (await fetch(`${BASE}/entities/${id}.json`)).json() : await (await fetch(`${BASE}/users/${id}.json`)).json();
                let div = document.createElement('div');
                div.className = `chat-item ${ACTIVE_CHAT === id ? 'active' : ''}`;
                div.innerHTML = `<img src="${info?.ava || DEF_AVA}" class="avatar"> <b>${info?.name || info?.nick || id}</b>`;
                div.onclick = () => { 
                    ACTIVE_CHAT = id; MY_TYPE = cData[id].type; OWNER = info?.owner || "";
                    document.getElementById('active-title').innerText = info?.name || info?.nick;
                    document.getElementById('active-info').innerText = id.startsWith('chan_') ? `ID: ${id}` : "–õ–∏—á–Ω—ã–π —á–∞—Ç";
                    document.getElementById('call-btn').style.display = (MY_TYPE === 'user') ? "block" : "none";
                    document.getElementById('chan-settings-btn').style.display = (OWNER === MY_ID) ? "block" : "none";
                    if(window.innerWidth < 768) toggleSidebar();
                    lastMsgHash = ""; sync();
                };
                list.appendChild(div);
            }
        }
        if(ACTIVE_CHAT) {
            let room = (MY_TYPE === 'user') ? [MY_ID, ACTIVE_CHAT].sort().join("_") : ACTIVE_CHAT;
            let mData = await (await fetch(`${BASE}/chats/${room}.json`)).json();
            if(JSON.stringify(mData) !== lastMsgHash) {
                lastMsgHash = JSON.stringify(mData);
                const box = document.getElementById('messages'); box.innerHTML = "";
                if(mData) {
                    Object.keys(mData).forEach(mid => {
                        let m = mData[mid], b = document.createElement('div');
                        b.className = `bubble ${m.sid === MY_ID ? 'me' : 'other'}`;
                        let content = m.text;
                        if(content.startsWith('[img]')) content = `<img src="${content.split('|')[1] || ''}" style="width:200px">`;
                        else if(content.startsWith('[vid]')) content = `<video controls src="${content.split('|')[1] || ''}" style="width:200px"></video>`;
                        else if(content.startsWith('[file]')) content = `üìÅ –§–∞–π–ª: ${content.split('|')[0].replace('[file]','')}`;
                        
                        b.innerHTML = `<small style="color:var(--accent)">${m.sender}</small><div>${content}</div>`;
                        box.appendChild(b);
                    });
                    box.scrollTop = box.scrollHeight;
                }
            }
        }
    }
    function closeModals() { document.querySelectorAll('.overlay').forEach(m => m.style.display = 'none'); }
</script>
</body>
</html>
